I"É-<p>Merhaba. Daha Ã¶nce <a href="https://enderahmetyurt.com/2018/01/09/gmail-e-eklenti-yazmak.html">Gmail add-on</a> nedir? Bu konudan biraz bahsetmiÅŸtim. Åimdi ise kÃ¼Ã§Ã¼k bir uygulama ile giriÅŸ yapÄ±p daha pratik birÅŸeyler gÃ¶stermek istiyorum.</p>

<p>Ã–ncelikle ihtiyacÄ±mÄ±z olan add-onâ€™u yazmak iÃ§in gerekli olan bir ortam. Google bize bu ortamÄ± <a href="https://script.google.com/">https://script.google.com/</a> ile veriyor. SonrasÄ±nda ise uygulamanÄ±n ayarlarÄ±nÄ±n ve kÃ¼tÃ¼phanelerinin baÄŸÄ±mlÄ±lÄ±klarÄ±nÄ±n bulunduÄŸu <code class="language-plaintext highlighter-rouge">manifest</code> dosyasÄ±nÄ± tanÄ±mlamak gerekiyor. Son olarak ise kodu yani <code class="language-plaintext highlighter-rouge">CardService</code>â€˜i yazmaya baÅŸlÄ±yoruz.</p>

<p>Manifest dosyasÄ±nÄ± <code class="language-plaintext highlighter-rouge">appscript.json</code> iÃ§ine koymak gerekiyor. Default olarak bu dosya kod yazdÄ±ÄŸÄ±mÄ±z yerde gÃ¶rÃ¼nÃ¼r deÄŸil o yÃ¼zden <code class="language-plaintext highlighter-rouge">View &gt; Show manifest file</code> diyoruz ve aÅŸaÄŸÄ±daki kodu dosyaya ekliyoruz.</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="w">  </span><span class="nl">"gmail"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Quickstart Toolbar Label"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"logoUrl"</span><span class="p">:</span><span class="w"> </span><span class="s2">"https://www.example.com/hosted/images/2x/my-icon.png"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"primaryColor"</span><span class="p">:</span><span class="w"> </span><span class="s2">"#4285F4"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"secondaryColor"</span><span class="p">:</span><span class="w"> </span><span class="s2">"#4285F4"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"contextualTriggers"</span><span class="p">:</span><span class="w"> </span><span class="p">[{</span><span class="w">
      </span><span class="nl">"unconditional"</span><span class="p">:</span><span class="w"> </span><span class="p">{},</span><span class="w">
      </span><span class="nl">"onTriggerFunction"</span><span class="p">:</span><span class="w"> </span><span class="s2">"getContextualAddOn"</span><span class="w">
    </span><span class="p">}],</span><span class="w">
    </span><span class="nl">"version"</span><span class="p">:</span><span class="w"> </span><span class="s2">"TRUSTED_TESTER_V2"</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>GÃ¶rdÃ¼ÄŸÃ¼nÃ¼z gibi bu dosya iÃ§inde basit bir ÅŸekilde config ayarlarÄ± yapÄ±lmÄ±ÅŸ durumda. UygulamanÄ±n adÄ±, logosu, renkler ve versiyon gibi basit Ã¶zelliklerin yanÄ±nda asÄ±l Ã¶nemli olan uygulama ilk baÅŸladÄ±ÄŸÄ±nda hangi metodun Ã§alÄ±ÅŸmasÄ± gerektiÄŸini sÃ¶yleyen <code class="language-plaintext highlighter-rouge">onTriggerFunction</code> parametresi. Bu parametre uygulama ayaÄŸa kalkÄ±nca ilk Ã§alÄ±ÅŸmasÄ± gereken metodu belirtiyor ve artÄ±k yapmamÄ±z gerekenler bu metot iÃ§inden Ã§alÄ±ÅŸmaya baÅŸlÄ±yor.</p>

<p>Google bizim iÃ§in <code class="language-plaintext highlighter-rouge">Code.gs</code> adÄ±nda bir google script dosyasÄ± aÃ§Ä±yor ve aslÄ±nda uygulama iÃ§in ilk Ã§alÄ±ÅŸan dosya burasÄ± oluyor. Bu dosya iÃ§ine uygulamamÄ±z ile alakalÄ± kodlarÄ± yazÄ±yoruz. Manifest dosyasÄ±nda belirttiÄŸimiz <code class="language-plaintext highlighter-rouge">getContextualAddOn</code> metodunu bu dosya iÃ§inde yazmaya baÅŸlÄ±yoruz.</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">function</span> <span class="nx">getContextualAddOn</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// Activate temporary Gmail add-on scopes, in this case to allow</span>
  <span class="c1">// message metadata to be read.</span>
  <span class="kd">var</span> <span class="nx">accessToken</span> <span class="o">=</span> <span class="nx">e</span><span class="p">.</span><span class="nx">messageMetadata</span><span class="p">.</span><span class="nx">accessToken</span><span class="p">;</span>
  <span class="nx">GmailApp</span><span class="p">.</span><span class="nx">setCurrentMessageAccessToken</span><span class="p">(</span><span class="nx">accessToken</span><span class="p">);</span>

  <span class="kd">var</span> <span class="nx">messageId</span> <span class="o">=</span> <span class="nx">e</span><span class="p">.</span><span class="nx">messageMetadata</span><span class="p">.</span><span class="nx">messageId</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">message</span> <span class="o">=</span> <span class="nx">GmailApp</span><span class="p">.</span><span class="nx">getMessageById</span><span class="p">(</span><span class="nx">messageId</span><span class="p">);</span>
  <span class="kd">var</span> <span class="nx">subject</span> <span class="o">=</span> <span class="nx">message</span><span class="p">.</span><span class="nx">getSubject</span><span class="p">();</span>
  <span class="kd">var</span> <span class="nx">sender</span> <span class="o">=</span> <span class="nx">message</span><span class="p">.</span><span class="nx">getFrom</span><span class="p">();</span>

  <span class="c1">// Create a card with a single card section and two widgets.</span>
  <span class="c1">// Be sure to execute build() to finalize the card construction.</span>
  <span class="kd">var</span> <span class="nx">exampleCard</span> <span class="o">=</span> <span class="nx">CardService</span><span class="p">.</span><span class="nx">newCardBuilder</span><span class="p">()</span>
  <span class="p">.</span><span class="nx">setHeader</span><span class="p">(</span><span class="nx">CardService</span><span class="p">.</span><span class="nx">newCardHeader</span><span class="p">()</span>
             <span class="p">.</span><span class="nx">setTitle</span><span class="p">(</span><span class="dl">'</span><span class="s1">Example card</span><span class="dl">'</span><span class="p">))</span>
  <span class="p">.</span><span class="nx">addSection</span><span class="p">(</span><span class="nx">CardService</span><span class="p">.</span><span class="nx">newCardSection</span><span class="p">()</span>
              <span class="p">.</span><span class="nx">addWidget</span><span class="p">(</span><span class="nx">CardService</span><span class="p">.</span><span class="nx">newKeyValue</span><span class="p">()</span>
                         <span class="p">.</span><span class="nx">setTopLabel</span><span class="p">(</span><span class="dl">'</span><span class="s1">Subject</span><span class="dl">'</span><span class="p">)</span>
                         <span class="p">.</span><span class="nx">setContent</span><span class="p">(</span><span class="nx">subject</span><span class="p">))</span>
              <span class="p">.</span><span class="nx">addWidget</span><span class="p">(</span><span class="nx">CardService</span><span class="p">.</span><span class="nx">newKeyValue</span><span class="p">()</span>
                         <span class="p">.</span><span class="nx">setTopLabel</span><span class="p">(</span><span class="dl">'</span><span class="s1">From</span><span class="dl">'</span><span class="p">)</span>
                         <span class="p">.</span><span class="nx">setContent</span><span class="p">(</span><span class="nx">sender</span><span class="p">)))</span>
  <span class="p">.</span><span class="nx">build</span><span class="p">();</span>   <span class="c1">// Don't forget to build the Card!</span>
  <span class="k">return</span> <span class="p">[</span><span class="nx">exampleCard</span><span class="p">];</span>
<span class="p">}</span>
</code></pre></div></div>

<p>YukarÄ±daki kodda amacÄ±mÄ±z bir email iÃ§eriÄŸine ulaÅŸabilmek. Bunun iÃ§in Gmailâ€™in servislerini kullanabilmemiz lazÄ±m. O yÃ¼zden Gmailâ€™e authenticate olmamÄ±z gerekiyor. Zaten uygulama Ã§alÄ±ÅŸmaya baÅŸladÄ±ÄŸÄ± zaman bu bize soruluyor ve onay verildikten sonra kod Ã§alÄ±ÅŸmaya baÅŸlÄ±yor. SonrasÄ±nda ise Card servisi devreye giriyor. Daha Ã¶nce de anlattÄ±ÄŸÄ±m gibi Gmail add-on iÃ§in UI desteÄŸi Card ile geliyor ve gelen veriyi kullanÄ±cÄ±ya gÃ¶stermek iÃ§in Ã¶ncellikle bir Card tanÄ±mlÄ±yoruz. SonrasÄ±nda ise gerekli componentâ€™larÄ± koyup son olarak Cardâ€™Ä± <code class="language-plaintext highlighter-rouge">build()</code> methodu ile oluÅŸturuyoruz. BurasÄ± Ã§ok Ã¶nemli. EÄŸer Cardâ€™Ä± hazÄ±rlayÄ±p, build metodunu Ã§aÄŸÄ±rmazsak isek istediÄŸimiz sonucu alamayÄ±z.</p>

<p>Biraz Cardâ€™lardan bahsetmek gerekirse. Cardâ€™lar onlar iÃ§in tanÄ±mlanmÄ±ÅŸ Ã¶zel <strong>widget</strong>â€˜lardan oluÅŸuyor. Her action iÃ§in yeni bir Card tanÄ±mlayabilir ve Ã¶zel widgetâ€™lar atayabiliriz iÃ§erlerine. CardBuilder classâ€™Ä± yeni bir Card tanÄ±mlamamÄ±za yarÄ±yor. Her Card <strong>header</strong> ve <strong>section</strong>â€˜lardan oluÅŸuyor. Bu sectionâ€™lar iÃ§ine kullanÄ±cÄ± ile kurulacak actionâ€™larÄ± tanÄ±mlama adÄ±na widgetâ€™larÄ± ekleyebiliyoruz. KÄ±sacasÄ± bir Card oluÅŸturmak iÃ§in sÄ±rasÄ±yla,</p>

<ul>
  <li>Widgetâ€™Ä± oluÅŸturmak</li>
  <li>Sectionâ€™a widgetâ€™Ä± eklemek</li>
  <li>Sectionâ€™a tÃ¼m widgetâ€™larÄ± tanÄ±mlayana kadar devam etmek,</li>
  <li>Son olarak ise sectionâ€™Ä± Cardâ€™a eklemek gerekiyor.</li>
</ul>

<p>Gelelim test ve deployment konusuna. FarklÄ± <a href="https://developers.google.com/apps-script/concepts/deployments">deployment yÃ¶ntemleri</a> mevcut fakat development tarafÄ±nda hÄ±zlÄ± test edebilmemiz iÃ§in <strong>Head Deployments</strong>â€˜dan bahsedeceÄŸim.</p>

<p>EÄŸer bÃ¼tÃ¼n kodu dÃ¼zgÃ¼n bir ÅŸekilde yazdÄ±ysak script ekranÄ±ndan <code class="language-plaintext highlighter-rouge">Publish &gt; Deploy from manifest</code> diyerek aÃ§Ä±lan pop-upâ€™dan <code class="language-plaintext highlighter-rouge">Lastest Version (HEAD)</code> satÄ±rÄ±ndan <strong>Get ID</strong> linkine tÄ±klayarak aÃ§Ä±lan pencereden <strong>Deployment ID</strong>â€˜yi kopyalayÄ±p, alÄ±yoruz ve ayrÄ± bir pencerede Gmail hesabÄ±mÄ± aÃ§Ä±yoruz.</p>

<p>Gmail iÃ§in ayarlarÄ±mÄ±zÄ±n yapÄ±ldÄ±ÄŸÄ± <strong>Settings</strong> sayfasÄ±na geliyoruz. Buradan <strong>Add-on</strong> sekmesinde yer alan <strong>Developer add-ons</strong> alanÄ±na biraz Ã¶nce kopyaladÄ±ÄŸÄ±mÄ±z Deployment IDâ€™yi yapÄ±ÅŸtÄ±rÄ±yoruz ve sonrasÄ±nda Install diyoruz. SonrasÄ±nda Inboxâ€™a gidip sayfasÄ± yeniliyoruz.</p>

<p>Inbox iÃ§inden herhangi bir emailâ€™e tÄ±kladÄ±ÄŸÄ±mÄ±z zaman saÄŸ tafta uygulama gÃ¶rÃ¼lecektir. Daha Ã¶nce de belirttiÄŸim gibi Gmail servislerini kullanmak iÃ§in Gmailâ€™e izin vermemiz gerekiyor. O yÃ¼zden <code class="language-plaintext highlighter-rouge">AUTHORIZE ACCESS</code> buttonuna tÄ±klayÄ±p, uygulama iÃ§in yetkilendirme izinini veriyoruz. Burada https ile baÄŸlanmadÄ±ÄŸÄ±mÄ±z ve uygulamamÄ±z development ortamÄ±nda olduÄŸu iÃ§in bir gÃ¼venlik sorunu Ã§Ä±kÄ±yor olabilir. Bu uyuglama size ait olduÄŸu iÃ§in kullanmaya devam et diyerek Gmail servislerinin bilgilerimize ulaÅŸmasÄ±na izin verebiliriz. SonrasÄ±nda uygulama Cardâ€™Ä± yeniden yÃ¼kleniyor ve uygulamanÄ±n Ã§alÄ±ÅŸtÄ±ÄŸÄ±nÄ± gÃ¶rebiliriz.</p>

<div style="display: flex; justify-content: center;"><img src="/public/images/gmail-add-on-ss.png" /></div>

<p>Sevgiler.</p>

<p><small>
<em>Referanslar:</em>
<em>https://developers.google.com/gmail/add-ons/how-tos/building</em>
</small></p>
:ET